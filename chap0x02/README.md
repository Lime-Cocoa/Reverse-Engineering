# 实验二

## 实验环境

* VMware Workstation
* Windows 7专业版
* OllyDebug

## 实验目的

* 对附件中的`Helloworld_CTF.exe`逆向工程，插入代码，弹出`messagebox`

## 实验过程

这次实验主要的思路是将`Helloworld_CTF.exe`反汇编得到汇编代码后，然后手动修改他的逻辑首先跳转到弹框区域再跳转回来去执行原来的代码。

首先使用`OllyDebug`将`Helloworld_CTF.exe`导入，此时已经自动定位到了入口点。

![](img/屏幕截图 2022-10-08 125044.png)

之后选择前`3`行将其复制，主要是为了空出足够的位置让我们完成指令的修改。

接下来我们需要找到`HEX`为`00`的地方，通常也就是尾部位置存在的空白位置。我们定位到尾部的`00`位置后，多选择一些行，右击-二进制-用`00`填充。

![](img/屏幕截图 2022-10-08 125828.png)

现在开始从`00405792`这个地址开始修改，我们选定这个位置后，开始打一个空格，尝试修改一下汇编代码，填入`push 0`。

![](img/屏幕截图 2022-10-08 130201.png)

之后我们再占用一下位置，填写一下如下的代码，这个`00405792`是我随意写的，只是为了占一个位置。

![](img/屏幕截图 2022-10-08 130327.png)

现在我们回到弹出`messagebox`的地方，观察一下其的语法

![](img/屏幕截图 2022-10-08 130554.png)

可以发现，要弹出`messagebox`我们需要`3`个`push`，`1`个`mov`，`1`个`call`。其中需要先压入一个常数，再分别压入标题和内容，接下来将`[local.1]`中的数据移入计数器`ecx`中，最后调用子函数`jmp.&MFC42D.#3517`，即可弹出`messagebox`。那我们只需要仿照其进行书写即可。回到刚刚修改的地方进行修改。

![](img/屏幕截图 2022-10-08 131539.png)

现在我们将最初的时候我们复制的启动时定位的那三行代码写在这里。再在其后加入一句跳转语句，此时的地址可以随意写，这里只是为了占位。

![](img/屏幕截图 2022-10-08 132331.png)

接下来我们在后面的空白处写入弹出`messagebox`时要显示的内容，右击-二进制-编辑。

![](img/屏幕截图 2022-10-08 132619.png)

![](img/屏幕截图 2022-10-08 132733.png)

回到当时占位的地方，在`00405794`位置修改为`push 004057B8`，在下一个位置修改为`push 004057C1`，也就是将刚才添加的字符串放置于此处引用。

![](img/屏幕截图 2022-10-08 133253.png)

紧接着我们修改启动逻辑，双击寄存器窗口中的`EIP`定位到入口位置。

![](img/屏幕截图 2022-10-08 133450.png)

最初的时候我们选择了前`3`行位置的代码进行了复制，现在我们同样选中前`3`行，然后右击-二进制-用`NOP`填充。

![](img/屏幕截图 2022-10-08 133716.png)

然后在第一个位置`00402F80`，填入`jmp 00405792`，也就是我们刚刚编辑过的空白处的第一个位置。

![](img/屏幕截图 2022-10-08 134001.png)

然后我们回到刚刚编辑的空白处的位置，我们还有一个跳回的操作，跳回到`00402F85`

![](img/屏幕截图 2022-10-08 135331.png)

到这基本就差不多了，思路就是从入口开始执行我们自己的代码，然后执行完了再跳转回去继续执行原来的代码。之后我们右击-复制到可执行文件-所有修改

![](img/屏幕截图 2022-10-08 135430.png)

然后选择全部复制

![](img/屏幕截图 2022-10-08 135535.png)

在弹出的窗口中右击-保存文件即可。

![](img/屏幕截图 2022-10-08 135627.png)

之后打开修改后的文件

![](img/屏幕截图 2022-10-08 135931.png)

成功弹出`messagebox`。